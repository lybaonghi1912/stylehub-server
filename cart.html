<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cart & Checkout ‚Äì STYLE HUB</title>
<link rel="stylesheet" href="css/style.css">
<script defer src="js/main.js"></script> 
<style>
/* Body + background */
body {
  background: linear-gradient(to right, #f7f7f7, #ffffff);
  font-family: Arial, sans-serif;
  color:#000;
  margin:0; padding:0;
}

/* Container */
.container { width:90%; max-width:1200px; margin:0 auto; }

/* Header */
header {background:#000; color:#fff; padding:15px 0; position:sticky; top:0; z-index:100;}
header .header-flex {display:flex; justify-content:space-between; align-items:center;}
header .logo {font-size:24px; font-weight:bold; color:#fff;}
header nav ul {display:flex; list-style:none;}
header nav ul li {margin-left:20px;}
header nav ul li a {color:#fff; text-decoration:none; font-weight:500;}
header nav ul li a:hover {color:#FFD700;}

/* Cart banner */
.cart-banner {
  text-align:center;
  margin:30px auto 20px auto;
  padding:20px;
  background:linear-gradient(90deg,#FFD700,#FFC107);
  border-radius:8px;
  font-weight:bold;
  font-size:20px;
  color:#000;
}

/* Cart container */
.cart-container {
  display:flex;
  gap:40px;
  justify-content:center;
  margin-bottom:50px;
  flex-wrap:wrap;
}

/* Left + Right boxes */
.cart-left, .cart-right {
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}

.cart-left { flex:2 1 600px; }
.cart-right { flex:1 1 350px; min-width:300px; }

/* Cart Table */
.cart-table { width:100%; border-collapse: collapse; }
.cart-table th, .cart-table td { padding:12px; text-align:center; border-bottom:1px solid #eee; }
.cart-table img { width:80px; border-radius:6px; }
.qty-input { width:50px; padding:4px; text-align:center; }
.btn-remove { background:#FF4C4C; color:#fff; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }
.cart-summary { text-align:right; font-size:16px; margin-bottom:20px; }
.cart-summary .total { font-weight:bold; font-size:18px; margin-top:10px; }
.btn-checkout, .btn-continue, .btn-submit-order {
  background:#000; color:#FFD700; padding:12px 20px;
  border:none; border-radius:6px; cursor:pointer; margin-top:10px; width:100%;
}
.btn-continue { background:#333; color:#FFD700; margin-bottom:15px; }

/* Checkout form */
.checkout-form { margin-top:20px; display:none; }
.checkout-form h3 { margin-bottom:15px; }
.checkout-form label { font-weight:bold; display:block; margin-top:10px; }
.checkout-form input, .checkout-form textarea { width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ccc; font-size:14px; }

/* Th√™m CSS cho th√¥ng b√°o l·ªói */
.checkout-form .error-msg {
  color: #FF4C4C; /* M√†u ƒë·ªè */
  font-size: 13px;
  margin-top: 5px;
  margin-bottom: 5px;
  display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
}
.checkout-form input.error, .checkout-form textarea.error {
  border: 1px solid #FF4C4C !important;
}

/* Footer */
footer {background:#000; color:#fff; padding:20px 0; text-align:center; margin-top:50px;}
footer p {margin-bottom:5px;}

/* Popups */
.popup-confirm, .popup-complete {
  position:fixed; top:0; left:0; right:0; bottom:0; display:none;
  justify-content:center; align-items:center; background: rgba(0,0,0,0.6); z-index:1000;
}
.popup-content { background:#fff; padding:30px; border-radius:8px; max-width:400px; width:100%; text-align:center; }
.popup-content button { margin:10px 5px; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; }
.btn-cancel { background:#ccc; color:#000; }
.btn-confirm { background:#FF4C4C; color:#fff; }

/* Responsive */
@media(max-width:992px){
  .cart-container { flex-direction:column; align-items:center; gap:20px; }
  .cart-left, .cart-right { width:100%; }
  .btn-checkout, .btn-continue { width:100%; }
}
</style>
</head>
<body>

<header>
  <div class="container header-flex">
    <h1 class="logo">STYLE HUB</h1>
    <nav>
      <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="cart.html">Cart <span id="cart-count">0</span></a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="cart-banner">üõí Black Friday Sale ‚Äì Your Cart & Checkout</div>

<div class="container cart-container">
  <div class="cart-left">
    <h2>Your Cart</h2>
    <table class="cart-table" id="cart-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Size</th>
          <th>Price</th>
          <th>Qty</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn-continue" id="btn-continue">Continue Shopping</button>
  </div>

  <div class="cart-right">
    <h2>Order Summary</h2>
    <div class="cart-summary" id="cart-summary"></div>

    <button class="btn-checkout" id="btn-checkout">Proceed to Checkout</button>

    <div class="checkout-form" id="checkout-form">
      <h3>Checkout Information</h3>
      <label>Name:</label><input type="text" id="customer-name" placeholder="Full name" required>
      <p id="error-name" class="error-msg">Vui l√≤ng nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß.</p>
      
      <label>Email:</label><input type="email" id="customer-email" placeholder="Email" required>
      <p id="error-email" class="error-msg">Vui l√≤ng nh·∫≠p Email h·ª£p l·ªá.</p>
      
      <label>Phone:</label><input type="text" id="customer-phone" placeholder="Phone number" required>
      <p id="error-phone" class="error-msg">Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.</p>
      
      <label>Address:</label><textarea id="customer-address" placeholder="Shipping address" rows="3" required></textarea>
      <p id="error-address" class="error-msg">Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.</p>
      
      <label>Note:</label><textarea id="customer-note" placeholder="Additional notes" rows="2"></textarea>
      <label>Payment Method:</label>
      <input type="text" value="Pay on Delivery" readonly style="background:#eee; cursor:not-allowed; margin-bottom:10px;">
      <button class="btn-submit-order" id="btn-submit-order">Submit Order</button>
      <p id="error-cart" class="error-msg" style="text-align:center; font-size:16px; margin-top:15px;">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
    </div>
  </div>
</div>

<div class="popup-confirm" id="popup-confirm">
  <div class="popup-content">
    <p>Are you sure you want to remove this item?</p>
    <button class="btn-cancel" id="btn-cancel">Cancel</button>
    <button class="btn-confirm" id="btn-confirm">Remove</button>
  </div>
</div>

<div class="popup-complete" id="popup-complete">
  <div class="popup-content">
    <h3>Thank you for your order!</h3>
    <p>Your order has been placed successfully.</p>
    <p id="order-total"></p> <button id="btn-close-complete">Close</button>
  </div>
</div>

<footer>
  <div class="container footer-content">
    <p>¬© 2025 STYLE HUB. All rights reserved.</p>
    <p>Contact: info@stylehub.com</p>
  </div>
</footer>

<script>
// Ki·ªÉm tra v√† s·ª≠ d·ª•ng formatVND, updateCartCount t·ª´ main.js
// N·∫øu main.js ch∆∞a load k·ªãp, ƒë·ªãnh nghƒ©a h√†m c∆° b·∫£n ƒë·ªÉ tr√°nh l·ªói
if (typeof formatVND === 'undefined') {
    function formatVND(n){ return n.toLocaleString('vi-VN')+'‚Ç´'; }
}
if (typeof updateCartCount === 'undefined') {
    function updateCartCount(){ 
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        const total = cart.reduce((a,b)=>a+(b.qty||1),0);
        const el = document.getElementById('cart-count');
        if(el) el.textContent = total; 
    }
}

let cart = [];
try{ cart = JSON.parse(localStorage.getItem('cart')||'[]'); } catch(e){ cart=[]; }

const cartTableBody = document.querySelector('#cart-table tbody');
const cartSummary = document.getElementById('cart-summary');
const cartCountEl = document.getElementById('cart-count');
const checkoutForm = document.getElementById('checkout-form');
const popupComplete = document.getElementById('popup-complete');
const orderTotalEl = document.getElementById('order-total');

updateCartCount();

let removeIndex = null;

function renderCart(){
  cartTableBody.innerHTML = '';
  if(cart.length===0){ 
    cartTableBody.innerHTML='<tr><td colspan="6">Your cart is empty</td></tr>'; 
    cartSummary.innerHTML=''; 
    // N·∫øu gi·ªè h√†ng tr·ªëng, ·∫©n form checkout
    checkoutForm.style.display = 'none';
    return; 
  }

  let subtotal=0;
  const shipping=50000;
  const discountRate=0.1;

  cart.forEach((item,index)=>{
    const qty=item.qty||1;
    const total=item.price*qty;
    subtotal+=total;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><img src="${item.img||'img/placeholder.png'}" alt="${item.name}"><br>${item.name}</td>
      <td>${item.size||'-'}</td>
      <td>${formatVND(item.price)}</td>
      <td><input type="number" min="1" value="${qty}" class="qty-input" data-index="${index}"></td>
      <td>${formatVND(total)}</td>
      <td><button class="btn-remove" data-index="${index}">Remove</button></td>
    `;
    cartTableBody.appendChild(tr);
  });

  const discount=subtotal*discountRate;
  const totalPay=subtotal-discount+shipping;

  cartSummary.innerHTML=`
    <div>Subtotal: ${formatVND(subtotal)}</div>
    <div>Black Friday Discount: -${formatVND(discount)}</div>
    <div>Shipping: ${formatVND(shipping)}</div>
    <div class="total">Total: ${formatVND(totalPay)}</div>
  `;

  document.querySelectorAll('.qty-input').forEach(input=>{
    input.addEventListener('change', e=>{
      let val=parseInt(e.target.value); if(val<1) val=1;
      const idx=e.target.dataset.index;
      cart[idx].qty=val;
      localStorage.setItem('cart',JSON.stringify(cart));
      renderCart(); updateCartCount();
    });
  });

  document.querySelectorAll('.btn-remove').forEach(btn=>{
    btn.addEventListener('click', e=>{
      removeIndex=e.target.dataset.index;
      document.getElementById('popup-confirm').style.display='flex';
    });
  });
}

document.getElementById('btn-cancel').addEventListener('click',()=>{ document.getElementById('popup-confirm').style.display='none'; removeIndex=null; });
document.getElementById('btn-confirm').addEventListener('click',()=>{
  if(removeIndex!==null){ 
    cart.splice(removeIndex,1); 
    localStorage.setItem('cart',JSON.stringify(cart)); 
    renderCart(); 
    updateCartCount(); 
    removeIndex=null; 
    document.getElementById('popup-confirm').style.display='none'; 
  }
});

document.getElementById('btn-continue').addEventListener('click',()=>{ location.href='products.html'; });
document.getElementById('btn-checkout').addEventListener('click',()=>{ 
    // Khi nh·∫•n Checkout, ƒë·∫£m b·∫£o gi·ªè h√†ng kh√¥ng tr·ªëng
    if (cart.length > 0) {
        checkoutForm.style.display='block'; 
        checkoutForm.scrollIntoView({behavior:'smooth'});
    } else {
        document.getElementById('error-cart').style.display = 'block';
        document.querySelector('.cart-container').scrollIntoView({behavior:'smooth'});
    }
});


// ======================================================
// H√ÄM VALIDATION M·ªöI
// ======================================================
function validateForm(name, email, phone, address) {
  let isValid = true;

  // H√†m ti·ªán √≠ch ƒë·ªÉ hi·ªÉn th·ªã l·ªói
  const displayError = (id, message = null) => {
    const errorEl = document.getElementById(`error-${id}`);
    const inputEl = document.getElementById(`customer-${id}`);
    if (message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      inputEl.classList.add('error');
      // Thi·∫øt l·∫≠p isValid th√†nh false n·∫øu c√≥ l·ªói
      isValid = false; 
    } else {
      errorEl.style.display = 'none';
      inputEl.classList.remove('error');
    }
  };
  
  // ·∫®n t·∫•t c·∫£ l·ªói tr∆∞·ªõc khi ki·ªÉm tra
  document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.checkout-form input, .checkout-form textarea').forEach(el => el.classList.remove('error'));

  // Ki·ªÉm tra Gi·ªè h√†ng
  if (cart.length === 0) {
    // Kh√¥ng c·∫ßn set isValid=false ·ªü ƒë√¢y v√¨ logic n√†y n·∫±m ngo√†i form inputs
    document.getElementById('error-cart').style.display = 'block';
    return false;
  }

  // 1. Ki·ªÉm tra T√™n
  if (!name) {
    displayError('name', 'Vui l√≤ng nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß.');
  } else {
    displayError('name');
  }

  // 2. Ki·ªÉm tra Email
  // Regex ki·ªÉm tra ƒë·ªãnh d·∫°ng email c∆° b·∫£n
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email) {
    displayError('email', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ Email.');
  } else if (!emailRegex.test(email)) {
    displayError('email', 'Email kh√¥ng h·ª£p l·ªá.');
  } else {
    displayError('email');
  }

  // 3. Ki·ªÉm tra S·ªë ƒëi·ªán tho·∫°i
  if (!phone) {
    displayError('phone', 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.');
  } else {
    displayError('phone');
  }

  // 4. Ki·ªÉm tra ƒê·ªãa ch·ªâ
  if (!address) {
    displayError('address', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.');
  } else {
    displayError('address');
  }

  return isValid;
}
// ======================================================
// H·∫æT H√ÄM VALIDATION
// ======================================================


// ===== LOGIC ƒê·∫∂T H√ÄNG C·∫¨P NH·∫¨T (G·ªçi Validation tr∆∞·ªõc khi g·ª≠i API) =====
document.getElementById('btn-submit-order').addEventListener('click', async () => {
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const address = document.getElementById('customer-address').value.trim();
  const note = document.getElementById('customer-note').value.trim();

  // ********** B∆Ø·ªöC 1: TH·ª∞C HI·ªÜN VALIDATION **********
  const formIsValid = validateForm(name, email, phone, address);
  
  if (!formIsValid) { 
    // N·∫øu Validation th·∫•t b·∫°i, cu·ªôn l√™n ƒë·∫ßu form ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y l·ªói
    document.getElementById('checkout-form').scrollIntoView({behavior:'smooth', block:'start'});
    return; 
  }
  // *************************************************

  // 2. T√çNH TO√ÅN T·ªîNG TI·ªÄN (Kh√¥ng ƒë·ªïi)
  let subtotal = 0; 
  cart.forEach(item => { subtotal += item.price * (item.qty || 1); });
  const shipping = 50000;
  const discount = subtotal * 0.1;
  const total = subtotal - discount + shipping;

  // 3. T·∫†O OBJECT ƒê∆†N H√ÄNG CHI TI·∫æT (Kh√¥ng ƒë·ªïi)
  const orderDetails = {
    customer: { name, email, phone, address, note },
    items: cart.map(item => ({ 
      id: item.id, 
      name: item.name, 
      size: item.size, 
      qty: item.qty || 1, 
      price: item.price,
      subtotal: item.price * (item.qty || 1)
    })),
    summary: { 
      subtotal: subtotal, 
      discount: discount, 
      shipping: shipping, 
      total: total 
    },
    orderDate: new Date().toISOString()
  };

  // 4. G·ªåI API G·ª¨I ƒê∆†N H√ÄNG (Kh√¥ng ƒë·ªïi)
  try {
      const response = await fetch('/api/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderDetails)
      });
      const result = await response.json();
      
      if (result.success) {
          // HI·ªÇN TH·ªä TH√îNG TIN CHI TI·∫æT ƒê√É ƒê·∫∂T L√äN POPUP
          orderTotalEl.innerHTML = `
            <p>M√£ ƒë∆°n h√†ng: <b>#${result.orderId}</b></p>
            <p>Kh√°ch h√†ng: <b>${name}</b></p>
            <p>Giao ƒë·∫øn: <b>${address}</b></p>
            <p style="font-size: 24px; color: #000; margin-top: 10px;">T·ªïng ti·ªÅn: <b>${formatVND(total)}</b></p>
          `;
          popupComplete.style.display = 'flex';

          // D·ªåN D·∫∏P GI·ªé H√ÄNG
          cart = [];
          localStorage.setItem('cart', JSON.stringify(cart));
          renderCart();
          updateCartCount();
      } else {
          alert('L·ªói ƒë·∫∑t h√†ng: ' + result.message);
      }

  } catch (e) {
      alert('L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i sau.');
      console.error(e);
  }
});

document.getElementById('btn-close-complete').addEventListener('click',()=>{ popupComplete.style.display='none'; });

renderCart();
</script>

</body>
</html>