<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cart & Checkout â€“ STYLE HUB</title>
<link rel="stylesheet" href="css/style.css">
<script defer src="js/main.js"></script> 
</head>
<body>

<header>
Â  <div class="container header-flex">
Â  Â  <h1 class="logo">STYLE HUB</h1>
Â  Â  <nav>
Â  Â  Â  <ul class="menu">
Â  Â  Â  Â  <li><a href="index.html">Home</a></li>
Â  Â  Â  Â  <li><a href="products.html">Products</a></li>
Â  Â  Â  Â  <li><a href="cart.html">Cart <span id="cart-count">0</span></a></li>
Â  Â  Â  Â  <li><a href="contact.html">Contact</a></li>
Â  Â  Â  </ul>
Â  Â  </nav>
Â  </div>
</header>

<div class="main-content-wrap">

    <div class="cart-banner">ğŸ›’ Black Friday Sale â€“ Your Cart & Checkout</div>

    <div class="container cart-container">
    Â  <div class="cart-left">
    Â  Â  <h2>Your Cart</h2>
    Â  Â  <table class="cart-table" id="cart-table">
    Â  Â  Â  <thead>
    Â  Â  Â  Â  <tr>
    Â  Â  Â  Â  Â  <th>Product</th>
    Â  Â  Â  Â  Â  <th>Size</th>
    Â  Â  Â  Â  Â  <th>Price</th>
    Â  Â  Â  Â  Â  <th>Qty</th>
    Â  Â  Â  Â  Â  <th>Total</th>
    Â  Â  Â  Â  Â  <th>Action</th>
    Â  Â  Â  Â  </tr>
    Â  Â  Â  </thead>
    Â  Â  Â  <tbody></tbody>
    Â  Â  </table>
    Â  Â  <button class="btn-continue" id="btn-continue">Continue Shopping</button>
    Â  </div>

    Â  <div class="cart-right">
    Â  Â  <h2>Order Summary</h2>
    Â  Â  <div class="cart-summary" id="cart-summary"></div>

    Â  Â  <button class="btn-checkout" id="btn-checkout">Proceed to Checkout</button>

    Â  Â  <div class="checkout-form" id="checkout-form">
    Â  Â  Â  <h3>Checkout Information</h3>
    Â  Â  Â  <label>Name:</label><input type="text" id="customer-name" placeholder="Full name" required>
    Â  Â  Â  <p id="error-name" class="error-msg">Vui lÃ²ng nháº­p tÃªn Ä‘áº§y Ä‘á»§.</p>
    Â  Â  Â  
    Â  Â  Â  <label>Email:</label><input type="email" id="customer-email" placeholder="Email" required>
    Â  Â  Â  <p id="error-email" class="error-msg">Vui lÃ²ng nháº­p Email há»£p lá»‡.</p>
    Â  Â  Â  
    Â  Â  Â  <label>Phone:</label><input type="text" id="customer-phone" placeholder="Phone number" required>
    Â  Â  Â  <p id="error-phone" class="error-msg">Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i.</p>
    Â  Â  Â  
    Â  Â  Â  <label>Address:</label><textarea id="customer-address" placeholder="Shipping address" rows="3" required></textarea>
    Â  Â  Â  <p id="error-address" class="error-msg">Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ giao hÃ ng.</p>
    Â  Â  Â  
    Â  Â  Â  <label>Note:</label><textarea id="customer-note" placeholder="Additional notes" rows="2"></textarea>
    Â  Â  Â  <label>Payment Method:</label>
    Â  Â  Â  <input type="text" value="Pay on Delivery" readonly style="background:#eee; cursor:not-allowed; margin-bottom:10px;">
    Â  Â  Â  <button class="btn-submit-order" id="btn-submit-order">Submit Order</button>
    Â  Â  Â  <p id="error-cart" class="error-msg" style="text-align:center; font-size:16px; margin-top:15px;">Giá» hÃ ng cá»§a báº¡n Ä‘ang trá»‘ng.</p>
    Â  Â  </div>
    Â  </div>
    </div>
</div>
<div class="popup-confirm" id="popup-confirm">
Â  <div class="popup-content">
Â  Â  <p>Are you sure you want to remove this item?</p>
Â  Â  <button class="btn-cancel" id="btn-cancel">Cancel</button>
Â  Â  <button class="btn-confirm" id="btn-confirm">Remove</button>
Â  </div>
</div>

<div class="popup-complete" id="popup-complete">
Â  <div class="popup-content">
Â  Â  <h3>Thank you for your order!</h3>
Â  Â  <p>Your order has been placed successfully.</p>
Â  Â  <p id="order-total"></p> <button id="btn-close-complete">Close</button>
Â  </div>
</div>

<footer>
Â  <div class="container footer-content">
Â  Â  <p>Â© 2025 STYLE HUB. All rights reserved.</p>
Â  Â  <p>Contact: info@stylehub.com</p>
Â  Â  <p style="font-size: 10px; opacity: 0.6;">(Footer Ä‘Ã£ Ä‘Æ°á»£c fix báº±ng Flexbox)</p>
Â  </div>
</footer>

<script>
// Kiá»ƒm tra vÃ  sá»­ dá»¥ng formatVND, updateCartCount tá»« main.js
// Náº¿u main.js chÆ°a load ká»‹p, Ä‘á»‹nh nghÄ©a hÃ m cÆ¡ báº£n Ä‘á»ƒ trÃ¡nh lá»—i
if (typeof formatVND === 'undefined') {
Â  Â  function formatVND(n){ return n.toLocaleString('vi-VN')+'â‚«'; }
}
if (typeof updateCartCount === 'undefined') {
Â  Â  function updateCartCount(){ 
Â  Â  Â  Â  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
Â  Â  Â  Â  const total = cart.reduce((a,b)=>a+(b.qty||1),0);
Â  Â  Â  Â  const el = document.getElementById('cart-count');
Â  Â  Â  Â  if(el) el.textContent = total; 
Â  Â  }
}

let cart = [];
try{ cart = JSON.parse(localStorage.getItem('cart')||'[]'); } catch(e){ cart=[]; }

const cartTableBody = document.querySelector('#cart-table tbody');
const cartSummary = document.getElementById('cart-summary');
const cartCountEl = document.getElementById('cart-count');
const checkoutForm = document.getElementById('checkout-form');
const popupComplete = document.getElementById('popup-complete');
const orderTotalEl = document.getElementById('order-total');

updateCartCount();

let removeIndex = null;

function renderCart(){
Â  cartTableBody.innerHTML = '';
Â  if(cart.length===0){ 
Â  Â  cartTableBody.innerHTML='<tr><td colspan="6">Your cart is empty</td></tr>'; 
Â  Â  cartSummary.innerHTML=''; 
Â  Â  // Náº¿u giá» hÃ ng trá»‘ng, áº©n form checkout
Â  Â  checkoutForm.style.display = 'none';
Â  Â  return; 
Â  }

Â  let subtotal=0;
Â  const shipping=50000;
Â  const discountRate=0.1;

Â  cart.forEach((item,index)=>{
Â  Â  const qty=item.qty||1;
Â  Â  const total=item.price*qty;
Â  Â  subtotal+=total;
Â  Â  const tr=document.createElement('tr');
Â  Â  tr.innerHTML=`
Â  Â  Â  <td><img src="${item.img||'img/placeholder.png'}" alt="${item.name}"><br>${item.name}</td>
Â  Â  Â  <td>${item.size||'-'}</td>
Â  Â  Â  <td>${formatVND(item.price)}</td>
Â  Â  Â  <td><input type="number" min="1" value="${qty}" class="qty-input" data-index="${index}"></td>
Â  Â  Â  <td>${formatVND(total)}</td>
Â  Â  Â  <td><button class="btn-remove" data-index="${index}">Remove</button></td>
Â  Â  `;
Â  Â  cartTableBody.appendChild(tr);
Â  });

Â  const discount=subtotal*discountRate;
Â  const totalPay=subtotal-discount+shipping;

Â  cartSummary.innerHTML=`
Â  Â  <div>Subtotal: ${formatVND(subtotal)}</div>
Â  Â  <div>Black Friday Discount: -${formatVND(discount)}</div>
Â  Â  <div>Shipping: ${formatVND(shipping)}</div>
Â  Â  <div class="total">Total: ${formatVND(totalPay)}</div>
Â  `;

Â  document.querySelectorAll('.qty-input').forEach(input=>{
Â  Â  input.addEventListener('change', e=>{
Â  Â  Â  let val=parseInt(e.target.value); if(val<1) val=1;
Â  Â  Â  const idx=e.target.dataset.index;
Â  Â  Â  cart[idx].qty=val;
Â  Â  Â  localStorage.setItem('cart',JSON.stringify(cart));
Â  Â  Â  renderCart(); updateCartCount();
Â  Â  });
Â  });

Â  document.querySelectorAll('.btn-remove').forEach(btn=>{
Â  Â  btn.addEventListener('click', e=>{
Â  Â  Â  removeIndex=e.target.dataset.index;
Â  Â  Â  document.getElementById('popup-confirm').style.display='flex';
Â  Â  });
Â  });
}

document.getElementById('btn-cancel').addEventListener('click',()=>{ document.getElementById('popup-confirm').style.display='none'; removeIndex=null; });
document.getElementById('btn-confirm').addEventListener('click',()=>{
Â  if(removeIndex!==null){ 
Â  Â  cart.splice(removeIndex,1); 
Â  Â  localStorage.setItem('cart',JSON.stringify(cart)); 
Â  Â  renderCart(); 
Â  Â  updateCartCount(); 
Â  Â  removeIndex=null; 
Â  Â  document.getElementById('popup-confirm').style.display='none'; 
Â  }
});

document.getElementById('btn-continue').addEventListener('click',()=>{ location.href='products.html'; });
document.getElementById('btn-checkout').addEventListener('click',()=>{ 
Â  Â  // Khi nháº¥n Checkout, Ä‘áº£m báº£o giá» hÃ ng khÃ´ng trá»‘ng
Â  Â  if (cart.length > 0) {
Â  Â  Â  Â  checkoutForm.style.display='block'; 
Â  Â  Â  Â  checkoutForm.scrollIntoView({behavior:'smooth'});
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('error-cart').style.display = 'block';
Â  Â  Â  Â  document.querySelector('.cart-container').scrollIntoView({behavior:'smooth'});
Â  Â  }
});


// ======================================================
// HÃ€M VALIDATION
// ======================================================
function validateForm(name, email, phone, address) {
Â  let isValid = true;

Â  // HÃ m tiá»‡n Ã­ch Ä‘á»ƒ hiá»ƒn thá»‹ lá»—i
Â  const displayError = (id, message = null) => {
Â  Â  const errorEl = document.getElementById(`error-${id}`);
Â  Â  const inputEl = document.getElementById(`customer-${id}`);
Â  Â  if (message) {
Â  Â  Â  errorEl.textContent = message;
Â  Â  Â  errorEl.style.display = 'block';
Â  Â  Â  inputEl.classList.add('error');
Â  Â  Â  // Thiáº¿t láº­p isValid thÃ nh false náº¿u cÃ³ lá»—i
Â  Â  Â  isValid = false; 
Â  Â  } else {
Â  Â  Â  errorEl.style.display = 'none';
Â  Â  Â  inputEl.classList.remove('error');
Â  Â  }
Â  };
Â  
Â  // áº¨n táº¥t cáº£ lá»—i trÆ°á»›c khi kiá»ƒm tra
Â  document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
Â  document.querySelectorAll('.checkout-form input, .checkout-form textarea').forEach(el => el.classList.remove('error'));

Â  // Kiá»ƒm tra Giá» hÃ ng
Â  if (cart.length === 0) {
Â  Â  document.getElementById('error-cart').style.display = 'block';
Â  Â  return false;
Â  }

Â  // 1. Kiá»ƒm tra TÃªn
Â  if (!name) {
Â  Â  displayError('name', 'Vui lÃ²ng nháº­p tÃªn Ä‘áº§y Ä‘á»§.');
Â  } else {
Â  Â  displayError('name');
Â  }

Â  // 2. Kiá»ƒm tra Email
Â  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
Â  if (!email) {
Â  Â  displayError('email', 'Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ Email.');
Â  } else if (!emailRegex.test(email)) {
Â  Â  displayError('email', 'Email khÃ´ng há»£p lá»‡.');
Â  } else {
Â  Â  displayError('email');
Â  }

Â  // 3. Kiá»ƒm tra Sá»‘ Ä‘iá»‡n thoáº¡i
Â  if (!phone) {
Â  Â  displayError('phone', 'Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i.');
Â  } else {
Â  Â  displayError('phone');
Â  }

Â  // 4. Kiá»ƒm tra Äá»‹a chá»‰
Â  if (!address) {
Â  Â  displayError('address', 'Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ giao hÃ ng.');
Â  } else {
Â  Â  displayError('address');
Â  }

Â  return isValid;
}
// ======================================================
// Háº¾T HÃ€M VALIDATION
// ======================================================


// ===== LOGIC Äáº¶T HÃ€NG Cáº¬P NHáº¬T (Gá»i Validation trÆ°á»›c khi gá»­i API) =====
document.getElementById('btn-submit-order').addEventListener('click', async () => {
Â  const name = document.getElementById('customer-name').value.trim();
Â  const email = document.getElementById('customer-email').value.trim();
Â  const phone = document.getElementById('customer-phone').value.trim();
Â  const address = document.getElementById('customer-address').value.trim();
Â  const note = document.getElementById('customer-note').value.trim();

Â  // ********** BÆ¯á»šC 1: THá»°C HIá»†N VALIDATION **********
Â  const formIsValid = validateForm(name, email, phone, address);
Â  
Â  if (!formIsValid) { 
Â  Â  // Náº¿u Validation tháº¥t báº¡i, cuá»™n lÃªn Ä‘áº§u form Ä‘á»ƒ ngÆ°á»i dÃ¹ng tháº¥y lá»—i
Â  Â  document.getElementById('checkout-form').scrollIntoView({behavior:'smooth', block:'start'});
Â  Â  return; 
Â  }
Â  // *************************************************

Â  // 2. TÃNH TOÃN Tá»”NG TIá»€N (KhÃ´ng Ä‘á»•i)
Â  let subtotal = 0; 
Â  cart.forEach(item => { subtotal += item.price * (item.qty || 1); });
Â  const shipping = 50000;
Â  const discount = subtotal * 0.1;
Â  const total = subtotal - discount + shipping;

Â  // 3. Táº O OBJECT ÄÆ N HÃ€NG CHI TIáº¾T (KhÃ´ng Ä‘á»•i)
Â  const orderDetails = {
Â  Â  customer: { name, email, phone, address, note },
Â  Â  items: cart.map(item => ({ 
Â  Â  Â  id: item.id, 
Â  Â  Â  name: item.name, 
Â  Â  Â  size: item.size, 
Â  Â  Â  qty: item.qty || 1, 
Â  Â  Â  price: item.price,
Â  Â  Â  subtotal: item.price * (item.qty || 1)
Â  Â  })),
Â  Â  summary: { 
Â  Â  Â  subtotal: subtotal, 
Â  Â  Â  discount: discount, 
Â  Â  Â  shipping: shipping, 
Â  Â  Â  total: total 
Â  Â  },
Â  Â  orderDate: new Date().toISOString()
Â  };

Â  // 4. Gá»ŒI API Gá»¬I ÄÆ N HÃ€NG (Sá»­ dá»¥ng API Server Ä‘Ã£ fix)
Â  try {
Â  Â  Â  const response = await fetch('/api/order', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify(orderDetails)
Â  Â  Â  });
Â  Â  Â  const result = await response.json();
Â  Â  Â  
Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  // HIá»‚N THá»Š THÃ”NG TIN CHI TIáº¾T ÄÃƒ Äáº¶T LÃŠN POPUP
Â  Â  Â  Â  Â  orderTotalEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <p>MÃ£ Ä‘Æ¡n hÃ ng: <b>#${result.orderId}</b></p>
Â  Â  Â  Â  Â  Â  <p>KhÃ¡ch hÃ ng: <b>${name}</b></p>
Â  Â  Â  Â  Â  Â  <p>Giao Ä‘áº¿n: <b>${address}</b></p>
Â  Â  Â  Â  Â  Â  <p style="font-size: 24px; color: #000; margin-top: 10px;">Tá»•ng tiá»n: <b>${formatVND(total)}</b></p>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  popupComplete.style.display = 'flex';

Â  Â  Â  Â  Â  // Dá»ŒN Dáº¸P GIá» HÃ€NG
Â  Â  Â  Â  Â  cart = [];
Â  Â  Â  Â  Â  localStorage.setItem('cart', JSON.stringify(cart));
Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  Â  updateCartCount();
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('Lá»—i Ä‘áº·t hÃ ng: ' + result.message);
Â  Â  Â  }

Â  } catch (e) {
Â  Â  Â  alert('Lá»—i káº¿t ná»‘i Server. Vui lÃ²ng thá»­ láº¡i sau.');
Â  Â  Â  console.error(e);
Â  }
});

document.getElementById('btn-close-complete').addEventListener('click',()=>{ popupComplete.style.display='none'; });

renderCart();
</script>

</body>
</html>